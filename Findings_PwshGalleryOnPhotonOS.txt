# Deploying Powershellgallery modules on VMware Photon OS isn't actually possible out-of-the-box.
#
# Deploy Powershell on Photon OS: tdnf -y install powershell 
# As on September 2019 the latest built-in installable powershell release is 6.1.0-271.
#
#
# This document stores the findings about prerequisites for Powershellgallery support on VMware Photon OS.
#
#
# Prerequisites:
#    VMware Photon OS 3.0
#
# 
# Workflow:
# ---------
# 1) Install Prerequisites
# 2) Build Powershell to run Powershellgallery
# 3) Run Pwsh\get-PSRepository
# 4) Result description
#
#
#
# Findings:
# ---------
#
# Finding #1
# 1) Vanilla VMware Photon OS 3.0 GA
# 2) Run all docker inside commands of https://github.com/vmware/powerclicore/blob/master/Dockerfile until get-PSRepository
# 3) Get-PSRepository fails with
     WARNING: Unable to find module repositories.
#
#
#    Stacktrace of 2)
root@photonos [ / ]# tdnf install -y powershell unzip
Refreshing metadata for: 'VMware Photon Linux 3.0(x86_64) Updates'
Refreshing metadata for: 'VMware Photon Extras 3.0(x86_64)'
Refreshing metadata for: 'VMware Photon Linux 3.0(x86_64)'
photon                                 2549558    100%
Installing:
userspace-rcu                        x86_64             0.10.1-1.ph3             photon             638.89k 654221
libunwind                            x86_64             1.2-2.ph3                photon             168.59k 172632
lttng-ust                            x86_64             2.10.2-2.ph3             photon               1.11M 1161968
icu                                  x86_64             61.1-1.ph3               photon              31.02M 32523835
dotnet-runtime                       x86_64             2.2.0-1.ph3              photon              66.61M 69841358
unzip                                x86_64             6.0-13.ph3               photon-updates     265.27k 271641
powershell                           x86_64             6.1.1-2.ph3              photon-updates     127.36M 133549330

Total installed size: 227.14M 238174985

Downloading:
userspace-rcu                           181074    100%
libunwind                                68246    100%
lttng-ust                               377915    100%
icu                                   12956251    100%
dotnet-runtime                        27442776    100%
unzip                                   131709    100%
powershell                            45891321    100%                  7417137     16%
Testing transaction
Running transaction
Installing/Updating: icu-61.1-1.ph3.x86_64
Installing/Updating: libunwind-1.2-2.ph3.x86_64
Installing/Updating: userspace-rcu-0.10.1-1.ph3.x86_64
Installing/Updating: lttng-ust-2.10.2-2.ph3.x86_64
Installing/Updating: dotnet-runtime-2.2.0-1.ph3.x86_64
Installing/Updating: powershell-6.1.1-2.ph3.x86_64
Installing/Updating: unzip-6.0-13.ph3.x86_64

Complete!
root@photonos [ / ]# cd /root
root@photonos [ ~ ]# curl -O -J -L https://www.powershellgallery.com/api/v2/package/PackageManagement && unzip PackageManagement -d /usr/lib/powershell/Modules/PackageManagement && rm -f PackageManagement
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   193  100   193    0     0    335      0 --:--:-- --:--:-- --:--:--   335
100 1031k  100 1031k    0     0  1362k      0 --:--:-- --:--:-- --:--:-- 8891k
Archive:  PackageManagement
  inflating: /usr/lib/powershell/Modules/PackageManagement/_rels/.rels
  inflating: /usr/lib/powershell/Modules/PackageManagement/PackageManagement.nuspec
  inflating: /usr/lib/powershell/Modules/PackageManagement/PackageManagement.cat
  inflating: /usr/lib/powershell/Modules/PackageManagement/PackageManagement.format.ps1xml
  inflating: /usr/lib/powershell/Modules/PackageManagement/PackageManagement.psd1
  inflating: /usr/lib/powershell/Modules/PackageManagement/PackageManagement.psm1
  inflating: /usr/lib/powershell/Modules/PackageManagement/PackageManagement.Resources.psd1
  inflating: /usr/lib/powershell/Modules/PackageManagement/PackageProviderFunctions.psm1
  inflating: /usr/lib/powershell/Modules/PackageManagement/coreclr/netstandard2.0/Microsoft.PackageManagement.ArchiverProviders.dll
  inflating: /usr/lib/powershell/Modules/PackageManagement/coreclr/netstandard2.0/Microsoft.PackageManagement.CoreProviders.dll
  inflating: /usr/lib/powershell/Modules/PackageManagement/coreclr/netstandard2.0/Microsoft.PackageManagement.dll
  inflating: /usr/lib/powershell/Modules/PackageManagement/coreclr/netstandard2.0/Microsoft.PackageManagement.MetaProvider.PowerShell.dll
  inflating: /usr/lib/powershell/Modules/PackageManagement/coreclr/netstandard2.0/Microsoft.PackageManagement.NuGetProvider.dll
  inflating: /usr/lib/powershell/Modules/PackageManagement/coreclr/netstandard2.0/Microsoft.PowerShell.PackageManagement.dll
  inflating: /usr/lib/powershell/Modules/PackageManagement/DSCResources/PackageManagementDscUtilities.psm1
  inflating: /usr/lib/powershell/Modules/PackageManagement/DSCResources/PackageManagementDscUtilities.strings.psd1
  inflating: /usr/lib/powershell/Modules/PackageManagement/DSCResources/MSFT_PackageManagement/MSFT_PackageManagement.psm1
  inflating: /usr/lib/powershell/Modules/PackageManagement/DSCResources/MSFT_PackageManagement/MSFT_PackageManagement.schema.mfl
  inflating: /usr/lib/powershell/Modules/PackageManagement/DSCResources/MSFT_PackageManagement/MSFT_PackageManagement.schema.mof
  inflating: /usr/lib/powershell/Modules/PackageManagement/DSCResources/MSFT_PackageManagement/MSFT_PackageManagement.strings.psd1
  inflating: /usr/lib/powershell/Modules/PackageManagement/DSCResources/MSFT_PackageManagementSource/MSFT_PackageManagementSource.psm1
  inflating: /usr/lib/powershell/Modules/PackageManagement/DSCResources/MSFT_PackageManagementSource/MSFT_PackageManagementSource.schema.mfl
  inflating: /usr/lib/powershell/Modules/PackageManagement/DSCResources/MSFT_PackageManagementSource/MSFT_PackageManagementSource.schema.mof
  inflating: /usr/lib/powershell/Modules/PackageManagement/DSCResources/MSFT_PackageManagementSource/MSFT_PackageManagementSource.strings.psd1
  inflating: /usr/lib/powershell/Modules/PackageManagement/fullclr/Microsoft.PackageManagement.ArchiverProviders.dll
  inflating: /usr/lib/powershell/Modules/PackageManagement/fullclr/Microsoft.PackageManagement.CoreProviders.dll
  inflating: /usr/lib/powershell/Modules/PackageManagement/fullclr/Microsoft.PackageManagement.dll
  inflating: /usr/lib/powershell/Modules/PackageManagement/fullclr/Microsoft.PackageManagement.MetaProvider.PowerShell.dll
  inflating: /usr/lib/powershell/Modules/PackageManagement/fullclr/Microsoft.PackageManagement.MsiProvider.dll
  inflating: /usr/lib/powershell/Modules/PackageManagement/fullclr/Microsoft.PackageManagement.MsuProvider.dll
  inflating: /usr/lib/powershell/Modules/PackageManagement/fullclr/Microsoft.PackageManagement.NuGetProvider.dll
  inflating: /usr/lib/powershell/Modules/PackageManagement/fullclr/Microsoft.PowerShell.PackageManagement.dll
  inflating: /usr/lib/powershell/Modules/PackageManagement/[Content_Types].xml
  inflating: /usr/lib/powershell/Modules/PackageManagement/package/services/metadata/core-properties/a7159c8d3c334695995d4d4c58a933fe.psmdcp
root@photonos [ ~ ]# curl -O -J -L https://www.powershellgallery.com/api/v2/package/PowerShellGet && unzip PowerShellGet-d /usr/lib/powershell/Modules/PowerShellGet && rm -f PowerShellGet
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   189  100   189    0     0    392      0 --:--:-- --:--:-- --:--:--   392
100  272k  100  272k    0     0   296k      0 --:--:-- --:--:-- --:--:-- 1559k
Archive:  PowerShellGet
  inflating: /usr/lib/powershell/Modules/PowerShellGet/_rels/.rels
  inflating: /usr/lib/powershell/Modules/PowerShellGet/PowerShellGet.nuspec
  inflating: /usr/lib/powershell/Modules/PowerShellGet/PowerShellGet.cat
  inflating: /usr/lib/powershell/Modules/PowerShellGet/PowerShellGet.psd1
  inflating: /usr/lib/powershell/Modules/PowerShellGet/PSGet.Format.ps1xml
  inflating: /usr/lib/powershell/Modules/PowerShellGet/PSGet.Resource.psd1
  inflating: /usr/lib/powershell/Modules/PowerShellGet/PSModule.psm1
  inflating: /usr/lib/powershell/Modules/PowerShellGet/DSCResources/MSFT_PSModule/MSFT_PSModule.psm1
  inflating: /usr/lib/powershell/Modules/PowerShellGet/DSCResources/MSFT_PSModule/MSFT_PSModule.schema.mfl
  inflating: /usr/lib/powershell/Modules/PowerShellGet/DSCResources/MSFT_PSModule/MSFT_PSModule.schema.mof
  inflating: /usr/lib/powershell/Modules/PowerShellGet/DSCResources/MSFT_PSModule/en-US/MSFT_PSModule.strings.psd1
  inflating: /usr/lib/powershell/Modules/PowerShellGet/DSCResources/MSFT_PSRepository/MSFT_PSRepository.psm1
  inflating: /usr/lib/powershell/Modules/PowerShellGet/DSCResources/MSFT_PSRepository/MSFT_PSRepository.schema.mfl
  inflating: /usr/lib/powershell/Modules/PowerShellGet/DSCResources/MSFT_PSRepository/MSFT_PSRepository.schema.mof
  inflating: /usr/lib/powershell/Modules/PowerShellGet/DSCResources/MSFT_PSRepository/en-US/MSFT_PSRepository.strings.psd1
  inflating: /usr/lib/powershell/Modules/PowerShellGet/en-US/PSGet.Resource.psd1
  inflating: /usr/lib/powershell/Modules/PowerShellGet/Modules/PowerShellGet.LocalizationHelper/PowerShellGet.LocalizationHelper.psm1
  inflating: /usr/lib/powershell/Modules/PowerShellGet/Modules/PowerShellGet.ResourceHelper/PowerShellGet.ResourceHelper.psm1
  inflating: /usr/lib/powershell/Modules/PowerShellGet/Modules/PowerShellGet.ResourceHelper/en-US/PowerShellGet.ResourceHelper.strings.psd1
  inflating: /usr/lib/powershell/Modules/PowerShellGet/[Content_Types].xml
  inflating: /usr/lib/powershell/Modules/PowerShellGet/package/services/metadata/core-properties/ac6ed28d8c464a69802b3e088b28aaab.psmdcp
root@photonos [ ~ ]# mkdir -p /usr/lib/powershell/ref/ && ln -s /usr/lib/powershell/*.dll /usr/lib/powershell/ref/
root@photonos [ ~ ]# pwsh
PowerShell 6.1.0-271-gc1e171622acb2917914fbc3fde69322b07863b3b
Copyright (c) Microsoft Corporation. All rights reserved.

https://aka.ms/pscore6-docs
Type 'help' to get help.

PS /root> get-psrepository
WARNING: Unable to find module repositories.
PS /root>

PS /root> get-psrepository -default
Get-PSRepository : A parameter cannot be found that matches parameter name 'default'.
At line:1 char:18
+ get-psrepository -default
+                  ~~~~~~~~
+ CategoryInfo          : InvalidArgument: (:) [Get-PSRepository], ParameterBindingException
+ FullyQualifiedErrorId : NamedParameterNotFound,Get-PSRepository

PS /root>

PS /root> Register-PSRepository -Name PSGallery -SourceLocation https://www.powershellgallery.com/api/v2/
Register-PSRepository : Use 'Register-PSRepository -Default' to register the PSGallery repository.
At line:1 char:1
+ Register-PSRepository -Name PSGallery -SourceLocation https://www.pow ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+ CategoryInfo          : InvalidArgument: (PSGallery:String) [Register-PSRepository], ArgumentException
+ FullyQualifiedErrorId : UseDefaultParameterSetOnRegisterPSRepository,Register-PSRepository

PS /root>

# 4) The solution provided in https://github.com/vmware/powerclicore/blob/master/Dockerfile does not work.
#    A workaround using Mono with nuget.exe in PwshGalleryonPhotonOS.sh works.
       Remark: It takes a huge overload of time and storage space simply to make use of the x86 commandline nuget.exe on Photon OS.
               Simplifying the installation by making a so called mkbundled nuget.exe failed. See Findings_MkbundledNuget.txt.
#
#
# Finding #2
# 1) Vanilla VMware Photon OS 3.0 GA
# 2) Install latest Powershell Core release v7.0.0.-preview.4. See https://github.com/PowerShell/PowerShell/releases/tag/v7.0.0-preview.4
# 3) Get-PSRepository fails with
     WARNING: Unable to find module repositories.
# 4) See Finding 1)
#
#
